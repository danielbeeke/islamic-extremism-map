"use strict";function debounce(t,e){var o;return function(){clearTimeout(o),o=setTimeout(t,e)}}function formatDate(t){var e=t.getFullYear(),o=("0"+(t.getMonth()+1)).slice(-2),a=("0"+t.getDate()).slice(-2);return e+"-"+o+"-"+a}function extend(t,e){if(null==t||"object"!=("undefined"==typeof t?"undefined":_typeof(t)))return t;if(t.constructor!=Object&&t.constructor!=Array)return t;if(t.constructor==Date||t.constructor==RegExp||t.constructor==Function||t.constructor==String||t.constructor==Number||t.constructor==Boolean)return new t.constructor(t);e=e||new t.constructor;for(var o in t)e[o]="undefined"==typeof e[o]?extend(t[o],null):e[o];return e}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};Array.prototype.clone=function(){return this.slice(0)},L.Map.include({closePopup:function(t){var e=this;if(t&&t!==this._popup||(t=this._popup,this._popup=null),t){L.DomUtil.addClass(t._container,"is-closing");var o=function a(){e.removeLayer(t),t._isOpen=!1,L.DomUtil.removeClass(t._container,"is-closing"),t._container.removeEventListener("transitionend",a)};t._container.addEventListener("transitionend",o)}return e}}),window.octopus=window.octopus?window.octopus:{},octopus.data={_data:[],download:function(t){var e=[];octopus.years.forEach(function(t){e.push(function(e){var o="../json/"+t+".json",a=new Worker("scripts/worker.data.get.js");a.postMessage(o),a.onmessage=function(t){a.terminate(),octopus.data._data=octopus.data._data.concat(t.data),e(null)}})}),async.parallel(e,function(e,o){e||"function"!=typeof t||t(),e&&console.error("Something happened while downloading the data.")})},get:function(t){octopus.data._data.length?"function"==typeof t&&t(octopus.data._data):octopus.data.download(function(){"function"==typeof t&&t(octopus.data._data)})},getFiltered:function(t,e){var o=!!e.minDate&&e.minDate,a=!!e.maxDate&&e.maxDate,n=e.types?e.types:[],r=e.bounds?e.bounds:null,s=[];octopus.data.get(function(e){e.forEach(function(t){var e=!0;!o&&!a||octopus.data._survivedFilterByDates(t,o,a)||(e=!1),n&&n.constructor===Array&&n.length&&!octopus.data._survivedFilterByTypes(t,n)&&(e=!1),r&&!octopus.data._survivedFilterByBounds(t,r)&&(e=!1),e&&s.push(t)}),"function"==typeof t&&t(s)})},_survivedFilterByBounds:function(t,e){if(t.geo.lat&&t.geo.lng&&"function"==typeof e.isValid&&e.isValid())return e.contains(L.latLng(t.geo.lat,t.geo.lng))},_survivedFilterByTypes:function(t,e){var o=!1;return e.forEach(function(e){t[e]&&(o=!0)}),o},_survivedFilterByDates:function(t,e,o){var a=!0;return e>Date.parse(t.date)&&(a=!1),o<Date.parse(t.date)&&(a=!1),a}},window.octopus=window.octopus?window.octopus:{},octopus.pie={create:function(t){var e=0;t.items.forEach(function(t){e+=t});var o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("height",t.size),o.setAttribute("width",t.size),o.setAttribute("class","pie-chart"),o.style.background=t.colors[0];var a=document.createElementNS("http://www.w3.org/2000/svg","circle"),n=t.size/3,r=t.size/2;a.setAttribute("r",n),a.setAttribute("cx",r),a.setAttribute("cy",r),a.setAttribute("class","pie-slice"),a.style.fill=t.colors[0],a.style.stroke=t.colors[1],a.style.strokeWidth=21.5*t.size*Math.PI/100;var s=2*Math.PI*n/100*(100/e*t.items[0]);return a.style.strokeDasharray=s+", "+2*Math.PI*n,o.appendChild(a),o}},octopus.router={parseHash:function(t){0===t.indexOf("#")&&(t=t.substr(1));var e=t.split("/");if(7==e.length){var o=parseInt(e[0],10),a=parseFloat(e[1]),n=parseFloat(e[2]),r=e[3],s=e[4],i=e[5],u=e[6];return!(isNaN(o)||isNaN(a)||isNaN(n)||!Date.parse(r)||!Date.parse(s)||isNaN(i)||isNaN(u))&&{center:new L.LatLng(a,n),zoom:o,start:r,end:s,killed:i,injured:u}}return!1},formatHash:function(t){var e,o,a=t.getCenter(),n=t.getZoom(),r=Math.max(0,Math.ceil(Math.log(n)/Math.LN2)),s=octopus.graph._graph.xAxis[0].getExtremes(),i=s.userMin?s.userMin:s.dataMin,u=new Date(i),c=s.userMax?s.userMax:s.dataMax,p=new Date(c);e=formatDate(u),o=formatDate(p);var l=0|octopus.graph._graph.series[1].visible,d=0|octopus.graph._graph.series[2].visible;return"#"+[n,a.lat.toFixed(r),a.lng.toFixed(r),e,o,l,d].join("/")},update:function(){var t=location.hash;if(t!==this.lastHash){var e=this.parseHash(t);if(e){this.movingMap=!0,this.map.setView(e.center,e.zoom);var o=new Date(e.start),a=new Date(e.end);octopus.graph._graph.xAxis[0].setExtremes(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate()),Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),!0,!1),this.movingMap=!1}else this.onMapMove(this.map)}},init:function(){octopus.map._hash=new L.Hash(octopus.map._map),octopus.map._hash.parseHash=octopus.router.parseHash,octopus.map._hash.formatHash=octopus.router.formatHash,octopus.map._hash.update=octopus.router.update}},window.octopus=window.octopus?window.octopus:{},octopus.graph={render:function(t,e,o){var a=octopus.graph._prepare(t);if(octopus.graph._graph=new Highcharts.StockChart({credits:{enabled:!1},chart:{zoomType:"x",renderTo:"chart",backgroundColor:"null",type:"arearange"},title:{text:""},rangeSelector:{enabled:!1,buttons:[],inputEnabled:!1},navigator:{margin:20,series:a.days},plotOptions:{series:{animation:!1,states:{hover:{enabled:!1}},events:{legendItemClick:debounce(function(){octopus.map._hash.onMapMove()},100)}},column:{stacking:"normal"}},legend:{enabled:!0,useHTML:!0,align:"right",layout:"horizontal",verticalAlign:"bottom",y:0,itemStyle:{color:"#E0E0E3"},itemHoverStyle:{color:"#FFF"},itemHiddenStyle:{color:"#444444"}},xAxis:{type:"datetime",useHTML:!0,labels:{enabled:!1,formatter:function(){if(this.isFirst||this.isLast)return Highcharts.dateFormat(this.dateTimeLabelFormat,this.value)}},events:{setExtremes:debounce(function(){octopus.map._hash.onMapMove();var t=octopus.getFilters();octopus.renderMap(t)},200)},min:Date.parse("2011-01-01"),max:Date.parse("2017-01-01")},yAxis:[{lineWidth:1,opposite:!0,visible:!1,maxPadding:.6},{lineWidth:1,visible:!1}],series:[{type:"spline",name:"Attacks",showInLegend:!1,yAxis:0,color:"#67b7ff",data:a.days},{type:"column",name:"Killed",yAxis:1,color:"#b80000",data:a.killed,weight:1},{type:"column",yAxis:1,name:"Injured",color:"#ea7070",data:a.injured,weight:0}]}),o.minDate&&o.maxDate){var n=new Date(o.minDate),r=new Date(o.maxDate);octopus.graph._graph.xAxis[0].setExtremes(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()),Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()),!0,!1)}"function"==typeof e&&e()},_prepare:function(t){var e={},o=[],a={},n={};t.forEach(function(t){e[Date.parse(t.date)]?(a[Date.parse(t.date)]+=parseInt(t.injured),n[Date.parse(t.date)]+=parseInt(t.killed),e[Date.parse(t.date)]++):(e[Date.parse(t.date)]=1,a[Date.parse(t.date)]=parseInt(t.injured),n[Date.parse(t.date)]=parseInt(t.killed),o.push(Date.parse(t.date)))});var r=[],s=[],i=[];return o.sort(),o.forEach(function(t){r.push([t,e[t]]),s.push([t,n[t]]),i.push([t,a[t]])}),{days:r,killed:s,injured:i}}},window.octopus=window.octopus?window.octopus:{},octopus.map={_tiles:"http://tilemill.studiofonkel.nl/style/{z}/{x}/{y}.png?id=tmstyle:///home/administrator/styles/terror-map.tm2&iqp86m8u",_mapSettings:{attributionControl:!1,minZoom:2,maxZoom:8,zoomControl:!1,worldCopyJump:!0},_clusterSettings:{showCoverageOnHover:!1,singleMarkerMode:!0,spiderfyDistanceMultiplier:2,maxClusterRadius:95,iconCreateFunction:function(t){return octopus.map._markerIconCallback(t)}},calculateBoundsByCenterAndZoom:function(t,e){var o=L.map("tempmap",{worldCopyJump:!0});o.setView(t,e,{animate:!1}),o.getSize=function(){return new L.Point(window.innerWidth,window.innerHeight-300)};var a=o.getBounds();return o.remove(),a},_markerIconCallback:function(t){var e=0,o=0;t.getAllChildMarkers().forEach(function(t){e+=parseInt(t._data.injured),o+=parseInt(t._data.killed)});var a=e+o,n=20;n=a<11?30:a>10&&a<101?40:a>100&&a<1001?50:a>1e3&&a<10001?60:a>1e4&&a<100001?70:90;var r=octopus.pie.create({size:n,items:[o,e],colors:["#ea7070","#b80000"]}),s=r.outerHTML+'<span class="number">'+a+"</span>";return new L.DivIcon({html:s,iconSize:L.point(n,n)})},_getItemMarkup:function(t){var e="";return e+="<p>"+t.description+"</p>",t.injured>0&&(e+='<div class="injured">'+t.injured+" injured</div>"),t.killed>0&&(e+='<div class="killed">'+t.killed+" killed</div>"),e+='<div class="date">'+t.date+"</div>",e+='<div class="city-country">'+t.city+", "+t.country+"</div>"},init:function(t){var e=octopus.filters&&octopus.filters.zoom?octopus.filters.zoom:2,o=octopus.filters&&octopus.filters.center?octopus.filters.center:[51.505,-.09];octopus.map._map=L.map("map",octopus.map._mapSettings),L.tileLayer(octopus.map._tiles).addTo(octopus.map._map),octopus.map._map.setView(o,e,{animate:!1}),octopus.map._cluster=L.markerClusterGroup(octopus.map._clusterSettings),octopus.map._cluster.addTo(octopus.map._map),octopus.map._map.on("viewreset, moveend",debounce(function(){var t=octopus.getFilters();octopus.renderGraph(t)},100)),"function"==typeof t&&t()},render:function(t,e){var o=function(){var o=[];t.forEach(function(t){t.geo&&t.geo.lat&&(t._marker=L.marker([t.geo.lat,t.geo.lng]).bindPopup(octopus.map._getItemMarkup(t)),t._marker._data=t,o.push(t._marker))}),octopus.map._cluster.addLayers(o),"function"==typeof e&&e()};octopus.map._map?(octopus.map._cluster.clearLayers(),o()):octopus.map.init(function(){o()})}},window.octopus=window.octopus?window.octopus:{},octopus.years=[2011,2012,2013,2014,2015,2016],octopus.getFilters=function(){var t=octopus.router.parseHash(window.location.hash),e=[];t.killed&&e.push("killed"),t.injured&&e.push("injured");var o;t.center&&t.zoom&&(o=octopus.map.calculateBoundsByCenterAndZoom(t.center,t.zoom));var a,n;if(octopus.graph._graph){var r=octopus.graph._graph.xAxis[0].getExtremes(),s=r.userMin?r.userMin:r.dataMin;a=new Date(s);var i=r.userMax?r.userMax:r.dataMax;n=new Date(i)}else a=t.start?Date.parse(t.start):null,n=t.end?Date.parse(t.end):null;return octopus.filters={minDate:a,maxDate:n,types:e,bounds:o?o:null,center:t.center?t.center:null,zoom:t.zoom?t.zoom:null},octopus.filters},octopus.init=function(){var t=octopus.getFilters();async.series([function(e){octopus.renderGraph(t,e)},function(e){octopus.renderMap(t,e)}],function(){octopus.router.init()})},octopus.renderGraph=function(t,e){var o=extend(t);o.minDate&&delete o.minDate,o.maxDate&&delete o.maxDate,octopus.data.getFiltered(function(o){octopus.graph.render(o,function(){"function"==typeof e&&e(null)},t)},o)},octopus.renderMap=function(t,e){var o=extend(t);o.bounds&&delete o.bounds,octopus.data.getFiltered(function(t){octopus.map.render(t,function(){"function"==typeof e&&e(null)})},o)},octopus.init();